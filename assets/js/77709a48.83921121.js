"use strict";(self.webpackChunkzzydoc=self.webpackChunkzzydoc||[]).push([[5724],{3905:(e,n,t)=>{t.d(n,{Zo:()=>g,kt:()=>m});var r=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var c=r.createContext({}),s=function(e){var n=r.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},g=function(e){var n=s(e.components);return r.createElement(c.Provider,{value:n},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,g=i(e,["components","mdxType","originalType","parentName"]),p=s(t),u=o,m=p["".concat(c,".").concat(u)]||p[u]||d[u]||a;return t?r.createElement(m,l(l({ref:n},g),{},{components:t})):r.createElement(m,l({ref:n},g))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,l=new Array(a);l[0]=u;var i={};for(var c in n)hasOwnProperty.call(n,c)&&(i[c]=n[c]);i.originalType=e,i[p]="string"==typeof e?e:o,l[1]=i;for(var s=2;s<a;s++)l[s]=t[s];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},86457:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>d,frontMatter:()=>a,metadata:()=>i,toc:()=>s});var r=t(87462),o=(t(67294),t(3905));const a={},l="\u4f7f\u7528 HTTP Middleware",i={unversionedId:"go-zero/extension/HTTP Middleware",id:"go-zero/extension/HTTP Middleware",title:"\u4f7f\u7528 HTTP Middleware",description:"\u4f7f\u7528\xa0HTTP Middleware \u53ef\u4ee5\u6709\u6548\u7684\u5bf9 HTTP \u7684\u8bf7\u6c42\u4f53\uff0c\u54cd\u5e94\u4f53\u8fdb\u884c\u62e6\u622a\uff0c\u505a\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u64cd\u4f5c\u3002",source:"@site/docs/go-zero/extension/HTTP Middleware.md",sourceDirName:"go-zero/extension",slug:"/go-zero/extension/HTTP Middleware",permalink:"/zzydoc/docs/go-zero/extension/HTTP Middleware",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"GoZero",previous:{title:"\u6d41\u6570\u636e\u5904\u7406\u5229\u5668",permalink:"/zzydoc/docs/go-zero/extension/stream"},next:{title:"JWT\u751f\u6210",permalink:"/zzydoc/docs/go-zero/extension/gen-jwt"}},c={},s=[],g={toc:s},p="wrapper";function d(e){let{components:n,...t}=e;return(0,o.kt)(p,(0,r.Z)({},g,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"\u4f7f\u7528-http-middleware"},"\u4f7f\u7528 HTTP Middleware"),(0,o.kt)("p",null,"\u4f7f\u7528\xa0HTTP Middleware \u53ef\u4ee5\u6709\u6548\u7684\u5bf9 HTTP \u7684\u8bf7\u6c42\u4f53\uff0c\u54cd\u5e94\u4f53\u8fdb\u884c\u62e6\u622a\uff0c\u505a\u4e00\u4e9b\u81ea\u5b9a\u4e49\u7684\u64cd\u4f5c\u3002"),(0,o.kt)("p",null,"\u5728 go-zero \u4e2d\u4f7f\u7528\xa0HTTP Middleware \u5171\u6709\u4e24\u79cd\u65b9\u5f0f\u3002"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u5168\u5c40 Middleware \u914d\u7f6e"),(0,o.kt)("li",{parentName:"ol"},"\u8def\u7531\u7ec4 Middleware \u914d\u7f6e")),(0,o.kt)("p",null,"\u63a5\u4e0b\u6765\u4ee5\u5feb\u901f\u5f00\u59cb\u4e2d\u6700\u57fa\u7840\u7684 greet \u9879\u76ee\u505a\u6f14\u793a\u3002"),(0,o.kt)("h1",{id:"\u51c6\u5907\u5de5\u4f5c"},"\u51c6\u5907\u5de5\u4f5c"),(0,o.kt)("p",null,"\u9996\u5148\u51c6\u5907\u4e00\u4e2a\u6700\u57fa\u672c\u7684 greet \u6f14\u793a\u9879\u76ee\u3002\u4ee5\u4e0b\u4ee3\u7801\u5747\u7531 goctl \u751f\u6210\uff0c\u672a\u8fdb\u884c\u7f16\u8f91\u3002"),(0,o.kt)("p",null,"\u9879\u76ee\u7ed3\u6784\u5982\u4e0b:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ tree                           \n.\n\u251c\u2500\u2500 etc\n\u2502   \u2514\u2500\u2500 greet-api.yaml\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u251c\u2500\u2500 greet.api\n\u251c\u2500\u2500 greet.go\n\u2514\u2500\u2500 internal\n    \u251c\u2500\u2500 config\n    \u2502   \u2514\u2500\u2500 config.go\n    \u251c\u2500\u2500 handler\n    \u2502   \u251c\u2500\u2500 greethandler.go\n    \u2502   \u2514\u2500\u2500 routes.go\n    \u251c\u2500\u2500 logic\n    \u2502   \u2514\u2500\u2500 greetlogic.go\n    \u251c\u2500\u2500 svc\n    \u2502   \u2514\u2500\u2500 servicecontext.go\n    \u2514\u2500\u2500 types\n        \u2514\u2500\u2500 types.go\n")),(0,o.kt)("p",null,"greet/greet.go:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport (\n    "flag"\n    "fmt"\n\n    "greet/internal/config"\n    "greet/internal/handler"\n    "greet/internal/svc"\n\n    "github.com/zeromicro/go-zero/core/conf"\n    "github.com/zeromicro/go-zero/rest"\n)\n\nvar configFile = flag.String("f", "etc/greet-api.yaml", "the config file")\n\nfunc main() {\n    flag.Parse()\n\n    var c config.Config\n    conf.MustLoad(*configFile, &c)\n\n    ctx := svc.NewServiceContext(c)\n    server := rest.MustNewServer(c.RestConf)\n    defer server.Stop()\n\n    handler.RegisterHandlers(server, ctx)\n\n    fmt.Printf("Starting server at %s:%d...\\n", c.Host, c.Port)\n    server.Start()\n}\n\n')),(0,o.kt)("p",null,"\u6211\u4eec\u5148\u5728 Greet \u65b9\u6cd5\u4e2d\u52a0\u5165\u4e00\u884c\u65e5\u5fd7\u8f93\u51fa\uff0c\u7528\u6765\u4ee3\u8868\u6211\u4eec\u7684\u4e1a\u52a1\u5904\u7406\u903b\u8f91"),(0,o.kt)("p",null,"greet/internal/logic/greetlogic.go :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package logic\n\nimport (\n    "context"\n\n    "greet/internal/svc"\n    "greet/internal/types"\n\n    "github.com/zeromicro/go-zero/core/logx"\n)\n\ntype GreetLogic struct {\n    logx.Logger\n    ctx    context.Context\n    svcCtx *svc.ServiceContext\n}\n\nfunc NewGreetLogic(ctx context.Context, svcCtx *svc.ServiceContext) GreetLogic {\n    return GreetLogic{\n        Logger: logx.WithContext(ctx),\n        ctx:    ctx,\n        svcCtx: svcCtx,\n    }\n}\n\nfunc (l *GreetLogic) Greet(req types.Request) (*types.Response, error) {\n    // \u5728\u8fd9\u91cc\u52a0\u5165\u4e1a\u52a1\u903b\u8f91\uff0c\u6211\u4eec\u7528\u6253\u5370\u65e5\u5fd7\u6765\u4ee3\u8868\u4e1a\u52a1\u903b\u8f91\n    l.Infof("name: %v", req.Name)\n    return &types.Response{}, nil\n}\n\n')),(0,o.kt)("h1",{id:"\u5168\u5c40-middleware-\u914d\u7f6e"},"\u5168\u5c40 Middleware \u914d\u7f6e"),(0,o.kt)("p",null,"\u9996\u5148\u6211\u4eec\u521b\u5efa\u4e00\u4e2a Middleware \u65b9\u6cd5"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'func middlewareDemoFunc(next http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        logx.Info("request ... ")\n        next(w, r)\n        logx.Info("reponse ... ")\n    }\n}\n')),(0,o.kt)("p",null,"\u7136\u540e\u5c06\u5176\u6ce8\u518c\u5230 go-zero \u7684 rest \u4e2d"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},"func main() {\n    \n    \xb7\xb7\xb7\n    \n    server := rest.MustNewServer(c.RestConf)\n    defer server.Stop()\n    \n    server.Use(\n        middlewareDemoFunc,\n    )\n    \n    \xb7\xb7\xb7\n\n    server.Start()\n}\n\n")),(0,o.kt)("p",null,"\u542f\u52a8\u9879\u76ee\uff0c\u5e76\u4f7f\u7528 curl \u8fdb\u884c\u8bf7\u6c42\uff0c\u7ec8\u7aef\u8f93\u51fa\u5982\u4e0b:"),(0,o.kt)("p",null,"curl:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'$ curl -i http://localhost:8888/from/you\nHTTP/1.1 200 OK\nContent-Type: application/json\nDate: Fri, 23 Oct 2020 07:42:48 GMT\nContent-Length: 14\n\n{"message":""}\n')),(0,o.kt)("p",null,"server:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'$ go run greet.go -f etc/greet-api.yaml\nStarting server at 0.0.0.0:8888...\n{"@timestamp":"2020-10-23T15:42:48.113+08","level":"info","content":"request..."}\n{"@timestamp":"2020-10-23T15:42:48.113+08","level":"info","content":"name: you","trace":"373939c095f9c52f","span":"0"}\n{"@timestamp":"2020-10-23T15:42:48.113+08","level":"info","content":"reponse..."}\n{"@timestamp":"2020-10-23T15:42:48.113+08","level":"info","content":"200 - /from/you - [::1]:52864 - curl/7.64.1 - 0.3ms","trace":"373939c095f9c52f","span":"0"}\n')),(0,o.kt)("h1",{id:"\u8def\u7531\u7ec4-middleware-\u914d\u7f6e"},"\u8def\u7531\u7ec4 Middleware \u914d\u7f6e"),(0,o.kt)("p",null,"\u8def\u7531\u7ec4 Middleware \u53ea\u5bf9\u7279\u5b9a\u7684\u8def\u7531\u6709\u6548\uff0c\u4f7f\u7528\u8def\u7531\u7ec4 Middleware \u53ea\u9700\u6211\u4eec\u5728\u6ce8\u518c\u8def\u7531\u65f6\u4f7f\u7528 ",(0,o.kt)("inlineCode",{parentName:"p"},"rest.WithMiddleware()"),"\xa0\u6216 ",(0,o.kt)("inlineCode",{parentName:"p"},"rest.WithMiddlewares()"),"\xa0\u65b9\u6cd5\u4f20\u5165\u6211\u4eec\u5b9a\u4e49\u7684 Middleware \u5373\u53ef\u3002"),(0,o.kt)("p",null,"goctl \u652f\u6301\u751f\u6210\u8def\u7531\u7ec4 Middleware "),(0,o.kt)("p",null,"\u5728 goctl \u4e2d\u53ef\u4f7f\u7528\u4ee5\u4e0b\u8bed\u6cd5\u6765\u5b9a\u4e49\u8def\u7531\u7ec4 Middleware "),(0,o.kt)("p",null,"greet/greet.api :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-protobuf"},"\xb7\xb7\xb7\n\n@server(\n    middleware: GreetMiddleware1, GreetMiddleware2\n)\nservice greet-api {\n  @handler GreetHandler\n  get /from/:name(Request) returns (Response);\n}\n\n\xb7\xb7\xb7\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"\u4f7f\u7528 goctl \u547d\u4ee4\u91cd\u65b0\u751f\u6210\u8def\u7531\u4ee3\u7801")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ goctl api go -api ./greet.api -dir .\netc/greet-api.yaml exists, ignored generation\ninternal/config/config.go exists, ignored generation\ngreet.go exists, ignored generation\ninternal/svc/servicecontext.go exists, ignored generation\ninternal/types/types.go exists, overwrite it?\nEnter to overwrite or Ctrl-C to cancel...\ninternal/handler/greethandler.go exists, ignored generation\ninternal/handler/routes.go exists, overwrite it?\nEnter to overwrite or Ctrl-C to cancel...\ninternal/logic/greetlogic.go exists, ignored generation\nDone.\n")),(0,o.kt)("p",null,"\u5177\u4f53\u4ee3\u7801\u5982\u4e0b:"),(0,o.kt)("p",null,"\u6ca1\u6709\u4f7f\u7528 Middleware \u7684\u8def\u7531\u7ec4"),(0,o.kt)("p",null,"greet/internal/handler/routes.go: "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'\xb7\xb7\xb7\n\nfunc RegisterHandlers(engine *rest.Server, serverCtx *svc.ServiceContext) {\n    engine.AddRoutes(\n        []rest.Route{\n            {\n                Method:  http.MethodGet,\n                Path:    "/from/:name",\n                Handler: greetHandler(serverCtx),\n            },\n        },\n    )\n}\n\n\xb7\xb7\xb7\n')),(0,o.kt)("p",null,"\u52a0\u5165 Middleware \u7684\u8def\u7531\u7ec4"),(0,o.kt)("p",null,"greet/internal/handler/routes.go: "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'\xb7\xb7\xb7\n\nfunc RegisterHandlers(engine *rest.Server, serverCtx *svc.ServiceContext) {\n    engine.AddRoutes(\n        rest.WithMiddlewares(\n            []rest.Middleware{serverCtx.GreetMiddleware1, serverCtx.GreetMiddleware2},\n            []rest.Route{\n                {\n                    Method:  http.MethodGet,\n                    Path:    "/from/:name",\n                    Handler: greetHandler(serverCtx),\n                },\n            }...,\n        ),\n    )\n )\n    \n\xb7\xb7\xb7\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a")," goctl \u547d\u4ee4\u884c\u5de5\u5177\u4e0d\u4f1a\u8986\u76d6 greet/internal/svc/servicecontext.go \u6587\u4ef6\uff0c\u800c\u4f7f\u7528 goctl \u5b9a\u4e49\u7684 Middleware \u65b9\u6cd5\u5728 greet/internal/svc/servicecontext.go \u4e2d\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u624b\u52a8\u4fee\u6539 greet/internal/svc/servicecontext.go \u6587\u4ef6\uff0c\u6dfb\u52a0\u6211\u4eec\u6240\u9700\u8981\u7684 ",(0,o.kt)("inlineCode",{parentName:"p"},"serverCtx.GreetMiddleware1"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"serverCtx.GreetMiddleware2")," \u65b9\u6cd5\u3002\u5728\u9996\u6b21\u751f\u6210\u4ee3\u7801\u7684\u65b0\u9879\u76ee\u4e2d\uff0c\u7531\u4e8e\u4e0d\u5b58\u5728 internal/svc/servicecontext.go \u6587\u4ef6\uff0cgoctl \u4f1a\u751f\u6210 Middleware \u65b9\u6cd5\u7684\u58f0\u660e\uff0c\u5177\u4f53\u5b9e\u73b0\u9700\u8981\u81ea\u5df1\u6765\u5b8c\u6210\u3002"),(0,o.kt)("p",null,"\u8fd9\u91cc\u7684 ",(0,o.kt)("inlineCode",{parentName:"p"},"serverCtx.GreetMiddleware1"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"serverCtx.GreetMiddleware2")," \u9700\u8981\u6211\u4eec\u81ea\u5df1\u8fdb\u884c\u5b9e\u73b0\u3002"),(0,o.kt)("p",null,"\u6211\u4eec\u7b80\u5355\u5b9e\u73b0\u4e00\u4e0b\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-go"},'package svc\n\nimport (\n    "greet/internal/config"\n    "net/http"\n\n    "github.com/zeromicro/go-zero/core/logx"\n    "github.com/zeromicro/go-zero/rest"\n)\n\ntype ServiceContext struct {\n    Config           config.Config\n    GreetMiddleware1 rest.Middleware\n    GreetMiddleware2 rest.Middleware\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    return &ServiceContext{\n        Config:           c,\n        GreetMiddleware1: greetMiddleware1,\n        GreetMiddleware2: greetMiddleware2,\n    }\n}\n\nfunc greetMiddleware1(next http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        logx.Info("greetMiddleware1 request ... ")\n        next(w, r)\n        logx.Info("greetMiddleware1 reponse ... ")\n    }\n}\n\nfunc greetMiddleware2(next http.HandlerFunc) http.HandlerFunc {\n    return func(w http.ResponseWriter, r *http.Request) {\n        logx.Info("greetMiddleware2 request ... ")\n        next(w, r)\n        logx.Info("greetMiddleware2 reponse ... ")\n    }\n}\n')),(0,o.kt)("p",null,"\u542f\u52a8\u670d\u52a1\u5e76\u4f7f\u7528 curl \u8fdb\u884c\u8bf7\u6c42\uff0c\u53ef\u4ee5\u89c2\u5bdf\u5230\u5982\u4e0b\u8f93\u51fa:"),(0,o.kt)("p",null,"curl:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'$ curl -i http://localhost:8888/from/you\nHTTP/1.1 200 OK\nContent-Type: application/json\nDate: Fri, 23 Oct 2020 08:14:27 GMT\nContent-Length: 14\n\n{"message":""}\n')),(0,o.kt)("p",null,"server:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'$ go run greet.go -f etc/greet-api.yaml\nStarting server at 0.0.0.0:8888...\n{"@timestamp":"2020-10-23T16:14:27.655+08","level":"info","content":"greetMiddleware1 request ... "}\n{"@timestamp":"2020-10-23T16:14:27.655+08","level":"info","content":"greetMiddleware2 request ... "}\n{"@timestamp":"2020-10-23T16:14:27.655+08","level":"info","content":"name: you","trace":"102aee4a4a935210","span":"0"}\n{"@timestamp":"2020-10-23T16:14:27.655+08","level":"info","content":"greetMiddleware2 reponse ... "}\n{"@timestamp":"2020-10-23T16:14:27.655+08","level":"info","content":"greetMiddleware1 reponse ... "}\n{"@timestamp":"2020-10-23T16:14:27.655+08","level":"info","content":"200 - /from/you - [::1]:53701 - curl/7.64.1 - 0.3ms","trace":"102aee4a4a935210","span":"0"}\n')))}d.isMDXComponent=!0}}]);