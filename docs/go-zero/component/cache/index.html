<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-go-zero/component/cache">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.3.1">
<link rel="alternate" type="application/rss+xml" href="/zerodoc/blog/rss.xml" title="ZZY的技术笔记 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zerodoc/blog/atom.xml" title="ZZY的技术笔记 Atom Feed">

<script src="https://hm.baidu.com/hm.js?748e7c913214342d8f0706348a9df9f3" async></script><title data-rh="true">缓存 | ZZY的技术笔记</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://amandayi.github.io/zerodoc/docs/go-zero/component/cache"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="缓存 | ZZY的技术笔记"><meta data-rh="true" name="description" content="前言"><meta data-rh="true" property="og:description" content="前言"><link data-rh="true" rel="canonical" href="https://amandayi.github.io/zerodoc/docs/go-zero/component/cache"><link data-rh="true" rel="alternate" href="https://amandayi.github.io/zerodoc/docs/go-zero/component/cache" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://amandayi.github.io/zerodoc/docs/go-zero/component/cache" hreflang="x-default"><link rel="stylesheet" href="/zerodoc/assets/css/styles.eeff9f6e.css">
<link rel="preload" href="/zerodoc/assets/js/runtime~main.8776a700.js" as="script">
<link rel="preload" href="/zerodoc/assets/js/main.c544b103.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zerodoc/"><div class="navbar__logo"><img src="/zerodoc/img/logo.svg" alt="" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zerodoc/img/logo.svg" alt="" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ZEROYI</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">技术笔记Note</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zerodoc/docs/redis/base">Redis6笔记</a></li><li><a class="dropdown__link" href="/zerodoc/docs/redis/cachepenetration">Redis应用问题</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/zerodoc/docs/go-zero/project/prepare">go-zero微服务文档</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/zerodoc/docs/go-zero/extension/bloom">微服务扩展阅读</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/react/base">react</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/vue/vue3base">vue</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/typescript/base">TypeScript</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/design/package">npm库开发</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/hybird/base">Hybird混合开发原理</a></li><li><a class="dropdown__link" href="/zerodoc/docs/devops/webops">简易持续集成</a></li><li><a class="dropdown__link" href="/zerodoc/docs/mysql/join">MySQL</a></li><li><a class="dropdown__link" href="/zerodoc/docs/orm/mybatis/">Mybatis笔记</a></li><li><a class="dropdown__link" href="/zerodoc/docs/wordpress/base">WordPress主题开发</a></li><li><a class="dropdown__link" href="/zerodoc/docs/project/officeOnlineEdit">办公文档多人同步编辑项目</a></li><li><a class="dropdown__link" href="/zerodoc/docs/structure/analyse">声网白板接入</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/rn/base">react native</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/webpack/">webpack5核心笔记</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/webpack3/">webpack常用功能30篇</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/video/">视频直播技术</a></li><li><a class="dropdown__link" href="/zerodoc/docs/js/normal/">JS常用功能记录</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">计算机基础知识</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zerodoc/docs/structure/analyse">数据结构与算法</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" positional="left">安全工程</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zerodoc/docs/rsecu/webjs/1">Web逆向工程</a></li></ul></div><a href="https://www.xinwenmh.cn" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">文学<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zerodoc/project">项目</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/zerodoc/"><img src="/zerodoc/img/logo.svg" alt="" class="themedImage_ToTc themedImage--light_HNdA"><img src="/zerodoc/img/logo.svg" alt="" class="themedImage_ToTc themedImage--dark_i4oU"><b>ZEROYI</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zerodoc/docs/go-zero/project/prepare">项目开发</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zerodoc/docs/go-zero/quick-start/concept">快速开始</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zerodoc/docs/go-zero/build-tool/tool-intro">构建工具</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/zerodoc/docs/go-zero/component/rest">框架组件</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/rest">rest</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zerodoc/docs/go-zero/component/cache">缓存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/breaker">熔断</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/load">降载</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/balance">负载均衡</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/discovery">服务发现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/trace">链路追踪</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/metric">指标监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/go-queue">延迟队列go-queue</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/mapreduce">mapReduce</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/rest engine">rest engine参数详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zerodoc/docs/go-zero/component/tokenparser">请求头JWT解析</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zerodoc/docs/go-zero/ecology/intellij">框架生态</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zerodoc/docs/go-zero/extension/bloom">扩展阅读</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zerodoc/docs/go-zero/problem/in-use">问题汇总</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/zerodoc/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">框架组件</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">缓存</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>缓存</h1><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="前言">前言<a href="#前言" class="hash-link" aria-label="前言的直接链接" title="前言的直接链接">​</a></h3><p>大家可以想一想：我们在流量激增的情况下，服务端哪个部分最有可能会是第一个瓶颈？我相信大部分人遇到的都会是数据库首先扛不住，量一起来，数据库慢查询，甚至卡死。此时，上层服务有怎么强的治理能力都是无济于事的。</p><p>所以我们常说看一个系统架构设计的好不好，很多时候看看缓存设计的如何就知道了。我们曾经遇到过这样的问题，在我加入之前，我们的服务是没有缓存的，虽然当时流量还不算高，但是每天到流量高峰时间段，大家就会特别紧张，一周宕机好几回，数据库直接被打死，然后啥也干不了，只能重启；我当时还是顾问，看了看系统设计，只能救急，就让大家先加上了缓存，但是由于大家对缓存的认知不够以及老系统的混乱，每个业务开发人员都会按照自己的方式来手撕缓存。这样导致的问题就是缓存用了，但是数据七零八落，压根没有办法保证数据的一致性。这确实是一个比较痛苦的经历，应该能引起大家的共鸣和回忆。</p><p>然后我把整个系统推倒重新设计了，其中缓存部分的架构设计在其中作用非常明显，于是有了今天的分享。</p><p>我主要分为以下几个部分跟大家探讨：</p><ul><li>缓存系统常见问题</li><li>单行查询的缓存与自动管理</li><li>多行查询缓存机制</li><li>分布式缓存系统设计</li><li>缓存代码自动化实践</li></ul><p>缓存系统涉及的问题和知识点是比较多的，我分为以下几个方面来讨论：</p><ul><li>稳定性</li><li>正确性</li><li>可观测性</li><li>规范落地和工具建设</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缓存系统稳定性">缓存系统稳定性<a href="#缓存系统稳定性" class="hash-link" aria-label="缓存系统稳定性的直接链接" title="缓存系统稳定性的直接链接">​</a></h3><p><img loading="lazy" alt="system stability" src="/zerodoc/assets/images/system-stability-64faa69c8433e0ad97873a633656ae46.png" width="1334" height="1058" class="img_ev3q"></p><p>缓存稳定性方面，网上基本所有的缓存相关文章和分享都会讲到三个重点：</p><ul><li>缓存穿透</li><li>缓存击穿</li><li>缓存雪崩</li></ul><p>为什么首先讲缓存稳定性呢？大家可以回忆一下，我们何时会引入缓存？一般都是当DB有压力，甚至经常被打挂的情况下才会引入缓存，所以我们首先就是为了解决稳定性的问题而引入缓存系统的。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缓存穿透">缓存穿透<a href="#缓存穿透" class="hash-link" aria-label="缓存穿透的直接链接" title="缓存穿透的直接链接">​</a></h3><p><img loading="lazy" alt="Cache Penetration" src="/zerodoc/assets/images/cache-penetration-443cd932f769939acdcb5cf39522c140.png" width="1328" height="460" class="img_ev3q"></p><p>缓存穿透存在的原因是请求不存在的数据，从图中我们可以看到对同一个数据的请求1会先去访问缓存，但是因为数据不存在，所以缓存里肯定没有，那么就落到DB去了，对同一个数据的请求2、请求3也同样会透过缓存落到DB去，这样当大量请求不存在的数据时DB压力就会特别大，尤其是可能会恶意请求打垮（不怀好意的人发现一个数据不存在，然后就大量发起对这个不存在数据的请求）。</p><p><code>go-zero</code> 的解决方法是：对于不存在的数据的请求我们也会在缓存里短暂（比如一分钟）存放一个占位符，这样对同一个不存在数据的DB请求数就会跟实际请求数解耦了，当然在业务侧也可以在新增数据时删除该占位符以确保新增数据可以立刻查询到。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缓存击穿">缓存击穿<a href="#缓存击穿" class="hash-link" aria-label="缓存击穿的直接链接" title="缓存击穿的直接链接">​</a></h3><p>缓存击穿的原因是热点数据的过期，因为是热点数据，所以一旦过期可能就会有大量对该热点数据的请求同时过来，这时如果所有请求在缓存里都找不到数据，如果同时落到DB去的话，那么DB就会瞬间承受巨大的压力，甚至直接卡死。</p><p><code>go-zero</code> 的解决方法是：对于相同的数据我们可以借助于 <code>core/syncx/SharedCalls</code> 来确保同一时间只有一个请求落到DB，对同一个数据的其它请求等待第一个请求返回并共享结果或错误，根据不同的并发场景，我们可以选择使用进程内的锁（并发量不是非常高），或者分布式锁（并发量很高）。如果不是特别需要，我们一般推荐进程内的锁即可，毕竟引入分布式锁会增加复杂度和成本，借鉴奥卡姆剃刀理论：如非必要，勿增实体。</p><p><img loading="lazy" alt="cache breakdown" src="/zerodoc/assets/images/cache-breakdown-66e8674dc85ccc74d56e3443ff629ae1.png" width="1430" height="904" class="img_ev3q"></p><p>我们来一起看一下上图缓存击穿防护流程，我们用不同颜色表示不同请求：</p><ul><li>绿色请求首先到达，发现缓存里没有数据，就去DB查询</li><li>粉色请求到达，请求相同数据，发现已有请求在处理中，等待绿色请求返回，singleflight模式</li><li>绿色请求返回，粉色请求用绿色请求共享的结果返回</li><li>后续请求，比如蓝色请求就可以直接从缓存里获取数据了</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缓存雪崩">缓存雪崩<a href="#缓存雪崩" class="hash-link" aria-label="缓存雪崩的直接链接" title="缓存雪崩的直接链接">​</a></h3><p>缓存雪崩的原因是大量同时加载的缓存有相同的过期时间，在过期时间到达的时候出现短时间内大量缓存过期，这样就会让很多请求同时落到DB去，从而使DB压力激增，甚至卡死。</p><p>比如疫情下在线教学场景，高中、初中、小学是分几个时间段同时开课的，那么这时就会有大量数据同时加载，并且设置了相同的过期时间，在过期时间到达的时候就会对等出现一个一个的DB请求波峰，这样的压力波峰会传递到下一个周期，甚至出现叠加。</p><p><code>go-zero</code> 的解决方法是：</p><ul><li>使用分布式缓存，防止单点故障导致的缓存雪崩</li><li>在过期时间上加上5%的标准偏差，5%是假设检验里P值的经验值（有兴趣的读者可以自行查阅）</li></ul><p><img loading="lazy" alt="cache avalanche" src="/zerodoc/assets/images/cache-avalanche-f7a8b646e1e08165a87031537eb5e40c.png" width="1406" height="866" class="img_ev3q"></p><p>我们做个实验，如果用1万个数据，过期时间设为1小时，标准偏差设为5%，那么过期时间会比较均匀的分布在3400~3800秒之间。如果我们的默认过期时间是7天，那么就会均匀分布在以7天为中心点的16小时内。这样就可以很好的防止了缓存的雪崩问题。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缓存正确性">缓存正确性<a href="#缓存正确性" class="hash-link" aria-label="缓存正确性的直接链接" title="缓存正确性的直接链接">​</a></h3><p>我们引入缓存的初衷是为了减小DB压力，增加系统稳定性，所以我们一开始关注的是缓存系统的稳定性。当稳定性解决之后，一般我们就会面临数据正确性问题，可能会经常遇到『明明数据更新了，为啥还是显示老的呢？』这类问题。这就是我们常说的『缓存数据一致性』问题了，接下来我们仔细下分析其产生的原因及应对方法。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="数据更新常见做法">数据更新常见做法<a href="#数据更新常见做法" class="hash-link" aria-label="数据更新常见做法的直接链接" title="数据更新常见做法的直接链接">​</a></h3><p>首先，我们讲数据一致性的前提是我们DB的更新和缓存的删除不会当成一个原子操作来看待，因为在高并发的场景下，我们不可能引入一个分布式锁来把这两者绑定为一个原子操作，如果绑定的话就会很大程度上影响并发性能，而且增加系统复杂度，所以我们只会追求数据的最终一致性，且本文只针对非追求强一致性要求的高并发场景，金融支付等同学自行判断。</p><p>常见数据更新方式有两大类，其余基本都是这两类的变种：</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="先删缓存再更新数据库">先删缓存，再更新数据库<a href="#先删缓存再更新数据库" class="hash-link" aria-label="先删缓存，再更新数据库的直接链接" title="先删缓存，再更新数据库的直接链接">​</a></h4><p><img loading="lazy" alt="delete update" src="/zerodoc/assets/images/delete-update-003e2b32a5e59a17869266b9295aeb9c.png" width="1396" height="758" class="img_ev3q"></p><p>这种做法是遇到数据更新，我们先去删除缓存，然后再去更新DB，如左图。让我们来看一下整个操作的流程：</p><ul><li>A请求需要更新数据，先删除对应的缓存，还未更新DB</li><li>B请求来读取数据</li><li>B请求看到缓存里没有，就去读取DB并将旧数据写入缓存（脏数据）</li><li>A请求更新DB</li></ul><p>可以看到B请求将脏数据写入了缓存，如果这是一个读多写少的数据，可能脏数据会存在比较长的时间（要么有后续更新，要么等待缓存过期），这是业务上不能接受的。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="先更新数据库再删除缓存">先更新数据库，再删除缓存<a href="#先更新数据库再删除缓存" class="hash-link" aria-label="先更新数据库，再删除缓存的直接链接" title="先更新数据库，再删除缓存的直接链接">​</a></h4><p><img loading="lazy" alt="update delete" src="/zerodoc/assets/images/update-delete-34191c4cf0c5941765c64a170808bd97.png" width="1326" height="784" class="img_ev3q"></p><p>上图的右侧部分可以看到在A更新DB和删除缓存之间B请求会读取到老数据，因为此时A操作还没有完成，并且这种读到老数据的时间是非常短的，可以满足数据最终一致性要求。</p><p>上图可以看到我们用的是删除缓存，而不是更新缓存，原因如下图：</p><p><img loading="lazy" alt="ab op" src="/zerodoc/assets/images/ab-op-9c606af3c199011b4d5718e7a046af59.png" width="1444" height="640" class="img_ev3q"></p><p>上图我用操作代替了删除或更新，当我们做删除操作时，A先删还是B先删没有关系，因为后续读取请求都会从DB加载出最新数据；但是当我们对缓存做的是更新操作时，就会对A先更新缓存还是B先更新缓存敏感了，如果A后更新，那么缓存里就又存在脏数据了，所以 go-zero 只使用删除缓存的方式。</p><p>我们来一起看看完整的请求处理流程：</p><p><img loading="lazy" alt="complete process" src="/zerodoc/assets/images/complete-process-54fabe0e07ae5b36eb1e756847a62e1c.png" width="1412" height="756" class="img_ev3q"></p><p>注意：不同颜色代表不同请求。</p><ul><li>请求1更新DB</li><li>请求2查询同一个数据，返回了老的数据，这个短时间内返回旧数据是可以接受的，满足最终一致性</li><li>请求1删除缓存</li><li>请求3再来请求时缓存里没有，就会查询数据库，并回写缓存再返回结果</li><li>后续的请求就会直接读取缓存了</li></ul><p>对于下图的场景，我们该怎么应对？</p><p><img loading="lazy" alt="caching scenarios" src="/zerodoc/assets/images/caching-scenarios-99db5292d8a615c68ed32431cde62793.png" width="1452" height="562" class="img_ev3q"></p><p>让我们来一起分析一下这个问题的几种可能解法：</p><ul><li><p>利用分布式锁让每次的更新变成一个原子操作。这种方法最不可取，就相当于自废武功，放弃了高并发能力，去追求强一致性，别忘了我之前文章强调过『这个系列文章只针对非追求强一致性要求的高并发场景，金融支付等同学自行判断』，所以这种解法我们首先放弃。</p></li><li><p>把 A删除缓存 加上延迟，比如过1秒再执行此操作。这样的坏处是为了解决这种概率极低的情况，而让所有的更新在1秒内都只能获取旧数据。这种方法也不是很理想，我们也不希望使用。</p></li><li><p>把 A删除缓存 这里改成设置一个特殊占位符，并让 B设置缓存 用 redis 的 setnx 指令，然后后续请求遇到这个特殊占位符时重新请求缓存。这个方法相当于在删除缓存时加了一种新的状态，我们来看下图的情况</p></li></ul><p><img loading="lazy" alt="cache placeholder" src="/zerodoc/assets/images/cache-placeholder-a795e3372d15761b4834b925597f3b8c.png" width="1428" height="566" class="img_ev3q"></p><p>是不是又绕回来了，因为A请求在遇到占位符时必须强行设置缓存或者判断是不是内容为占位符。所以这也解决不了问题。</p><p>那我们看看 go-zero 是怎么应对这种情况的，我们选择对这种情况不做处理，是不是很吃惊？那么我们回到原点来分析这种情况是怎么发生的：</p><ul><li>对读请求的数据没有缓存（压根没加载到缓存或者缓存已失效），触发了DB读取</li><li>此时来了一个对该数据的更新操作</li><li>需要满足这样的顺序：B请求读DB -&gt; A请求写DB -&gt; A请求删除缓存 -&gt; B请求设置缓存</li></ul><p>我们都知道DB的写操作需要锁行记录，是个慢操作，而读操作不需要，所以此类情况相对发生的概率比较低。而且我们有设置过期时间，现实场景遇到此类情况概率极低，要真正解决这类问题，我们就需要通过 2PC 或是 Paxos 协议保证一致性，我想这都不是大家想用的方法，太复杂了！</p><p>做架构最难的我认为是懂得取舍（trade-off），寻找最佳收益的平衡点是非常考验综合能力的。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缓存可观测性">缓存可观测性<a href="#缓存可观测性" class="hash-link" aria-label="缓存可观测性的直接链接" title="缓存可观测性的直接链接">​</a></h3><p>前面两篇文章我们解决了缓存的稳定性和数据一致性问题，此时我们的系统已经充分享受到了缓存带来的价值，解决了从零到一的问题，那么我们接下来要考虑的是如何进一步降低使用成本，判断哪些缓存带来了实际的业务价值，哪些可以去掉，从而降低服务器成本，哪些缓存我需要增加服务器资源，各个缓存的 qps 是多少，命中率多少，有没有需要进一步调优等。</p><p><img loading="lazy" alt="cache log" src="/zerodoc/assets/images/cache-log-a5e329262ff1df21d89977bc2f4cd8e6.png" width="1372" height="402" class="img_ev3q"></p><p>上图是一个服务的缓存监控日志，可以看出这个缓存服务的每分钟有5057个请求，其中99.7%的请求都命中了缓存，只有13个落到DB了，DB都成功返回了。从这个监控可以看到这个缓存服务把DB压力降低了三个数量级（90%命中是一个数量级，99%命中是两个数量级，99.7%差不多三个数量级了），可以看出这个缓存的收益是相当可以的。</p><p>但如果反过来，缓存命中率只有0.3%的话就没什么收益了，那么我们就应该把这个缓存去掉，一是可以降低系统复杂度（如非必要，勿增实体嘛），二是可以降低服务器成本。</p><p>如果这个服务的 qps 特别高（足以对DB造成较大压力），那么如果缓存命中率只有50%，就是说我们降低了一半的压力，我们应该根据业务情况考虑增加过期时间来增加缓存命中率。</p><p>如果这个服务的 qps 特别高（足以对缓存造成较大压力），缓存命中率也很高，那么我们可以考虑增加缓存能够承载的 qps 或者加上进程内缓存来降低缓存的压力。</p><p>所有这些都是基于缓存监控的，只有可观测了，我们才能做进一步有针对性的调优和简化，我也一直强调『没有度量，就没有优化』。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何让缓存被规范使用">如何让缓存被规范使用？<a href="#如何让缓存被规范使用" class="hash-link" aria-label="如何让缓存被规范使用？的直接链接" title="如何让缓存被规范使用？的直接链接">​</a></h3><p>了解 go-zero 设计思路或者看过我的分享视频的同学可能对我经常讲的『工具大于约定和文档』有印象。</p><p>对于缓存来说，知识点是非常繁多的，每个人写出的缓存代码一定会风格迥异，而且所有知识点都写对是非常难的，就像我这种写了那么多年程序的老鸟来说，一次让我把所有知识点都写对，依然是非常困难的。那么 go-zero 是怎么解决这个问题的呢？</p><ul><li>尽可能把抽象出来的通用解决方法封装到框架里。这样整个缓存的控制流程就不需要大家来操心了，只要你调用正确的方法，就没有出错的可能性。</li><li>把从建表 sql 到 CRUD + Cache 的代码都通过工具一键生成。避免了大家去根据表结构写一堆结构和控制逻辑。</li></ul><p><img loading="lazy" alt="cache generate" src="/zerodoc/assets/images/cache-generate-d97bf4286710df39916f354a3a3400d8.png" width="1308" height="618" class="img_ev3q"></p><p>这是从 go-zero 的官方示例 <code>bookstore</code> 里截的一个 <code>CRUD + Cache</code> 的生成说明。我们可以通过指定的建表 <code>sql</code> 文件或者 <code>datasource</code> 来提供给 <code>goctl</code> 所需的 <code>schema</code>，然后 <code>goctl</code> 的 <code>model</code> 子命令可以一键生成所需的 <code>CRUD + Cache</code> 代码。</p><p>这样就确保了所有人写的缓存代码都是一样的，工具生成能不一样吗？</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/zerodoc/docs/go-zero/component/rest"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">rest</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zerodoc/docs/go-zero/component/breaker"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">熔断</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前言" class="table-of-contents__link toc-highlight">前言</a></li><li><a href="#缓存系统稳定性" class="table-of-contents__link toc-highlight">缓存系统稳定性</a></li><li><a href="#缓存穿透" class="table-of-contents__link toc-highlight">缓存穿透</a></li><li><a href="#缓存击穿" class="table-of-contents__link toc-highlight">缓存击穿</a></li><li><a href="#缓存雪崩" class="table-of-contents__link toc-highlight">缓存雪崩</a></li><li><a href="#缓存正确性" class="table-of-contents__link toc-highlight">缓存正确性</a></li><li><a href="#数据更新常见做法" class="table-of-contents__link toc-highlight">数据更新常见做法</a></li><li><a href="#缓存可观测性" class="table-of-contents__link toc-highlight">缓存可观测性</a></li><li><a href="#如何让缓存被规范使用" class="table-of-contents__link toc-highlight">如何让缓存被规范使用？</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">探索</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zerodoc/docs/js/design/package">前端通用工具库设计开发</a></li><li class="footer__item"><a class="footer__link-item" href="/zerodoc/docs/project/officeOnlineEdit">金山文档在线编辑接入</a></li><li class="footer__item"><a class="footer__link-item" href="/zerodoc/docs/devops/webops">纯静态文件的持续集成发布</a></li></ul></div><div class="col footer__col"><div class="footer__title">基础知识</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zerodoc/docs/js/typescript/base">TypeScript</a></li><li class="footer__item"><a class="footer__link-item" href="/zerodoc/docs/redis/transaction">Redis事务与锁</a></li><li class="footer__item"><a class="footer__link-item" href="/zerodoc/docs/js/webpack3/01">webpack常用功能30篇</a></li></ul></div><div class="col footer__col"><div class="footer__title">计算机</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zerodoc/docs/structure/analyse">数据结构与算法</a></li></ul></div><div class="col footer__col"><div class="footer__title">VDom</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zerodoc/docs/js/react/base">React</a></li><li class="footer__item"><a class="footer__link-item" href="/zerodoc/docs/js/vue/vue3base">Vue</a></li></ul></div><div class="col footer__col"><div class="footer__title">其他</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://regexper.com/" target="_blank" rel="nofollow noopener noreferrer" class="footer__link-item">正则表达式流程图转换<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://sentinelguard.io/zh-cn/index.html" target="_blank" rel="nofollow noopener noreferrer" class="footer__link-item">分布式流量控制组件<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">
								<div>以生死为此岸，涅槃为彼岸，此岸苦苦挣扎，彼岸超然洒脱。</div>
								<!-- <div>Copy right © 2024  Inc. By ZeroYi</div> -->
<!--								<div><a href="https://beian.miit.gov.cn/" target="_blank" class="footer__link-item">豫ICP备2023031390号-1</a></div>-->
							</div></div></div></footer></div>
<script src="/zerodoc/assets/js/runtime~main.8776a700.js"></script>
<script src="/zerodoc/assets/js/main.c544b103.js"></script>
</body>
</html>